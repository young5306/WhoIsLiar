``` PowerShell

pipeline {
    agent any

    environment {
        BACKEND_DIR = 'backend'
        FRONTEND_DIR = 'frontend'
        MATTERMOST_WEBHOOK = 'https://meeting.ssafy.com/hooks/uhartpf6jp8ztxugodzq4br3xh'
    }

    tools {
        nodejs "NodeJS 22"
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    try {
                        git branch: 'deploy',
                            credentialsId: 'gitlab-pipeline',
                            url: 'https://lab.ssafy.com/s12-final/S12P31A604.git'
                    } catch (Exception e) {
                        sh """
                            curl -X POST -H 'Content-Type: application/json' \\
                            -d '{ "text": ":x: **[ì‹¤íŒ¨] Checkout ë‹¨ê³„ ì˜¤ë¥˜**" }' \\
                            ${MATTERMOST_WEBHOOK}
                        """
                        error("Checkout stage failed")
                    }
                }
            }
        }

        stage('Start') {
            steps {
                script {
                    try {
                        sh """
                            curl -X POST -H 'Content-Type: application/json' \\
                            -d '{ "text": "## :rocket: **ë°°í¬ ì‹œì‘** :rocket:" }' \\
                            ${MATTERMOST_WEBHOOK}
                        """
                    } catch (Exception e) {
                        sh """
                            curl -X POST -H 'Content-Type: application/json' \\
                            -d '{ "text": "## :x: **[ì‹¤íŒ¨] Start ë‹¨ê³„ ì˜¤ë¥˜**" }' \\
                            ${MATTERMOST_WEBHOOK}
                        """
                        error("Start stage failed")
                    }
                }
            }
        }

        stage('Build Backend') {
            steps {
                script {
                    try {
                        sh """
                            cd ${BACKEND_DIR}
                            chmod +x gradlew  
                            ./gradlew clean bootJar
                        """
                    } catch (Exception e) {
                        sh """
                            curl -X POST -H 'Content-Type: application/json' \\
                            -d '{ "text": "## :x: **[ì‹¤íŒ¨] ë°±ì—”ë“œ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ**" }' \\
                            ${MATTERMOST_WEBHOOK}
                        """
                        error("Backend build failed")
                    }
                }
            }
        }

        stage('Build Frontend') {
            steps {
                script {
                    try {
                        sh """
                            cd ${FRONTEND_DIR}
                            echo "VITE_APP_API_URL=https://whoisliar.me/api" > .env
                            echo "VITE_APP_WEBSOCKET_URL=https://whoisliar.me/ws" >> .env
                            npm install
                            npm run build
                        """
                    } catch (Exception e) {
                        sh """
                            curl -X POST -H 'Content-Type: application/json' \\
                            -d '{ "text": "## :x: **[ì‹¤íŒ¨] í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ**" }' \\
                            ${MATTERMOST_WEBHOOK}
                        """
                        error("Frontend build failed")
                    }
                }
            }
        }

        stage('Blue-Green Deploy') {
            steps {
                script {
                    try {
                        def current = sh(
                            script: "docker exec nginx grep -Po '(?<=server backend-)[a-z]+' /etc/nginx/conf.d/default.conf | head -n1",
                            returnStdout: true
                        ).trim()

                        def target = (current == 'green') ? 'blue' : 'green'
                        def backendNew = "backend-${target}"
                        def backendOld = "backend-${current}"
                        def frontendNew = "frontend-${target}"
                        def frontendOld = "frontend-${current}"

                        echo "í˜„ì¬ í™œì„±í™”: ${current}"
                        echo "ë°°í¬ ëŒ€ìƒ: ${target}"

                        sh "docker-compose up -d --build ${backendNew} ${frontendNew}"

                        sh """
                            until curl -sf http://${backendNew}:8080/actuator/health | grep UP; do sleep 2; done
                            until curl -sf -o /dev/null http://${frontendNew}:80; do sleep 2; done
                        """

                        sh """
                            sed -i 's/server backend-${current}/server ${backendNew}/'   ${WORKSPACE}/nginx.conf
                            sed -i 's/server frontend-${current}/server ${frontendNew}/' ${WORKSPACE}/nginx.conf
                            docker exec -i nginx sh -c 'cat > /etc/nginx/conf.d/default.conf' < ${WORKSPACE}/nginx.conf
                            docker exec nginx nginx -t
                            docker exec nginx nginx -s reload
                        """

                        echo "íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ â†’ ${target} í™œì„±í™”"
                        echo "Old ì»¨í…Œì´ë„ˆ(${frontendOld}, ${backendOld}) ë‹¤ìš´"

                        sh "docker-compose stop ${frontendOld} ${backendOld}"
                        sh "docker-compose rm -f ${frontendOld} ${backendOld}"

                        echo "${frontendOld}, ${backendOld} ì œê±° ì™„ë£Œ"
                    } catch (Exception e) {
                        sh """
                            curl -X POST -H 'Content-Type: application/json' \\
                            -d '{ "text": "## :x: **[ì‹¤íŒ¨] ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (Blue-Green ë‹¨ê³„)**" }' \\
                            ${MATTERMOST_WEBHOOK}
                        """
                        error("Blue-Green deploy failed")
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                def deployedColor = sh(
                    script: "docker exec nginx grep -Po '(?<=server backend-)[a-z]+' /etc/nginx/conf.d/default.conf | head -n1",
                    returnStdout: true
                ).trim()

                def timestamp = sh(
                    script: "date '+%m-%d %Hì‹œ%Më¶„%Sì´ˆ'",
                    returnStdout: true
                ).trim()

                def emojis = (deployedColor == "green") ?
                    " :green_face_bounce: " : " :blue_heart_yj: "

                def triggeredUser = env.GITLAB_USER_NAME ?:
                    currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause')[0]?.userName ?:
                    sh(script: "git log -1 --pretty=format:'%an'", returnStdout: true).trim()

                def commitLogs = sh(
                    script: "git log -5 --pretty=format:'- %an: %s'",
                    returnStdout: true
                ).trim()

                def text = """

### :server_close: í˜„ì¬ í™œì„±í™”ëœ ì„œë²„: ${emojis}

### ğŸ•’ ë°°í¬ ì‹œê°:  ${timestamp}

### :bear_bow_thankyou: ë°°í¬ì: ${triggeredUser}

### :messageneun: ì»¤ë°‹ ë‚´ì—­:
${commitLogs}
""".stripIndent().trim()

                def jsonMessage = """{
  "text": "${text.replace('"', '\\"').replace('\n', '\\n')}"
}"""

                sh """
                    curl -X POST -H 'Content-Type: application/json' \\
                    -d '${jsonMessage}' \\
                    ${MATTERMOST_WEBHOOK}
                """
            }
        }

        failure {
            script {
                sh """
                    curl -X POST -H 'Content-Type: application/json' \\
                    -d '{ "text": "# :fire: **ë°°í¬ ì‹¤íŒ¨** :fire:" }' \\
                    ${MATTERMOST_WEBHOOK}
                """
            }
        }
    }
}
```